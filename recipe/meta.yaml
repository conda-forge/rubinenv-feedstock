{% set name = "rubin-env" %}
{% set version = "0.8.3" %}
{% set build_number = 0 %}

package:
  name: {{ name }}
  version: {{ version }}

build:
  skip: True         # [python_impl == 'pypy' or win]
  number: {{ build_number }}

outputs:
  - name: rubin-env-nosysroot
    script: build-nosysroot.sh
    # Since all requirements are required "at run time" for the
    # Rubin developers, all requirements are fundamentally
    # run requirements. However, we've attempted to organize
    # requirements as build-like, host-like, or run-like, in
    # order inform any evolution of this recipe.
    requirements:
      run:
        # jq is special - it is needed for the pin-it utility in this package
        - jq >=1.6
        # build-like dependencies
        # As part of our scons build process, we do run tests, so
        # these really are required to perform a build.
        # Note that "testing" in conda-forge should be limited to testing
        # successful packaging, and not testing code.
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        # The above are needed to get the official conda-forge versions.
        # The below is needed to get convenience symlinks for users to invoke.
        - compilers >=1.2
        - cmake >=3.21
        - doxygen >=1.9
        - flake8 =3.8.4
        - make >=4.3
        - pep8-naming >=0.11
        - pip >=21.3
        - psutil >=5.8
        - pytest >=6.2
        - pytest-cov >=3.0
        - pytest-doctestplus >=0.11
        - pytest-flake8 >=1.0
        - pytest-openfiles >=0.5
        - pytest-runner >=5.3
        - pytest-session2file >=0.1
        - pytest-subtests >=0.5
        - pytest-xdist >=2.4
        - scons >=4.2
        # host-like and run-like
        # These are mostly run-like, but for the same reasons as
        # above, we need most of these at build time, so they are mostly
        # host-like
        - boost =1.74
        - cfitsio =3
        - eigen =3.3
        - eups >=2.2.3
        - firefly-client >=2.8
        - galsim =2.2
        - libaprutil =1
        # there is some issue with pex_exceptions with clang 11 and libcxx 12
        # until it is tracked down, it makes sense to keep these at the same
        # major version
        - libcxx =={{ cxx_compiler_version }}.*  # [osx]
        - log4cxx =0
        - lsst-documenteer-pipelines >=0.6.9
        - lsst-documenteer-technote >=0.6.9
        - minuit2 =6
        - mpich =3
        - starlink-ast =9
        - wcslib =7
        - xpa =2
        # run-like
        - alembic >=1.7
        - apr =1
        - autograd >=1.3
        - astropy >=4.3
        - backoff >=1.11
        - boto3 >=1.19
        - bottleneck >=1.3
        # conda is required for runtime inspection of installed software
        - conda >=4.10
        - cffi =1
        - click >=7.1,<8
        # breaks multiprocessing tests
        - coverage !=6.3
        - cython =0
        - deprecated >=1.2
        - dustmaps >=1.0
        - esutil >=0.6
        - fastavro >=1.4
        - future >=0.18
        - git >=2.33
        - git-lfs >=3.0
        - gsl =2
        - h5py >=3.4
        - healpy >=1.15
        - healsparse >=1.4
        - idds-client >=0.9.5
        - idds-doma >=0.9.5
        # inflection may go away in the future; see DM-32591
        - inflection >=0.5
        - lmfit >=1.0,!=1.0.3
        - lsstdesc.coord >=1.2
        - matplotlib-base >=3.4,<3.6
        - moto >=2.2,<3
        - mpi4py >=3.1
        - ndarray =1
        - networkx >=2.5,<2.6
        - numexpr =2
        - numpy =1.20
        - pandas >=1.2,<1.3
        - pgcli >=3.2
        - piff >=1.0
        - prmon  # [linux]
        - psycopg2 =2
        - pyarrow >=5.0
        - pybind11 >=2.8
        - pydantic >=1.8
        # pytables 3.7 loses mock dependency that we inadvertently need
        - pytables =3.6
        - python =3.8
        - pyyaml >=6.0
        - requests >=2.26
        - responses <=0.18.0
        - scikit-image >=0.17,<0.18
        - scikit-learn >=1.0
        - scipy >=1.7,<1.9
        - seaborn >=0.11
        - sqlalchemy >=1.4,<2
        - sqlite >=3.34.0,<3.35
        - treecorr =4
        - ws4py >=0.5

    test:
      commands:
        # grep pin-it output for python dependency
        - pin-it rubin-env | grep "python="
        # ensure binary compatibility; bump major version if not
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1013 ]'  # [linux]
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1002 ]'  # [osx]

  - name: rubin-env
    requirements:
      run:
        - {{ pin_subpackage("rubin-env-nosysroot", exact=True) }}
        - sysroot_linux-64 =2.17  # [linux64]
    test:
      commands:
        # grep pin-it output for python dependency
        - pin-it rubin-env | grep "python="
        # ensure binary compatibility; bump major version if not
        - '[ $(echo __GXX_ABI_VERSION | ${GXX} -E - | tail -1) == 1013 ]'  # [linux]
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1002 ]'  # [osx]

  - name: rubin-env-rsp
    requirements:
      host:
        - python =3.8
      run:
        - {{ pin_subpackage("rubin-env", exact=True) }}
        # All are from sciplat-lab unless otherwise stated
        - astroplan # sims
        - astroquery
        - astrowidgets  # [not aarch64]
        - awkward
        - awkward-numba
        - black
        - bokeh
        - bqplot
        - ciso8601  # [not aarch64]
        - cloudpickle
        - cookiecutter
        - dash
        - dask
        - dask-kubernetes
        - dask_labextension
        - datashader
        - distributed
        - fastparquet
        - ffmpeg # RFC-846
        - freetype-py
        - gcsfs
        - geoviews
        - ginga
        - graphviz
        - holoviews
        - hvplot
        - imagemagick # RFC-846
        - intake
        - intake-parquet
        - ipyevents
        - ipykernel
        - ipympl
        - ipyvolume
        - ipywidgets
        - isort
        - jedi
        - jupyter
        - jupyter-dash  # [not aarch64]
        - jupyter-packaging
        - jupyter-server-proxy
        - jupyter_bokeh
        - jupyterhub
        - jupyterlab >=3,<4
        - jupyterlab_execute_time
        - jupyterlab_iframe
        - jupyterlab_widgets
        - mamba
        - mypy
        - mysqlclient
        - nbconvert-webpdf
        - nbdime
        - nbval
        - nodejs >=16
        - numba
        - panel # shared
        - papermill
        - paramnb
        - partd
        - pep8 # shared
        - plotly
        - pre-commit
        - pyflakes # shared
        - pypandoc
        - pyshp
        - python-snappy
        - python-socketio
        - pythreejs
        - pyviz_comms
        - pyvo
        - sidecar
        - snappy
        - terminado
        - toolz
        - wget
        - xarray
        - yarn
    test:
      commands:
        # grep pin-it output for yarn dependency
        - pin-it rubin-env-rsp | grep "yarn="

about:
  home: https://github.com/conda-forge/rubinenv-feedstock
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE.txt
  summary: Metapackage to install the Rubin Observatory's common software environment.

  description: |
    This metapackage exists to define the Rubin Observatory common software
    environment, including version specifications where needed, while allowing
    users flexibility when installing additional packages into the same environment.

extra:
  recipe-maintainers:
    - brianv0
    - timj
    - ktlim
    - beckermr
