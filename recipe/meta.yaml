{% set name = "rubin-env" %}
{% set version = "3.0.0" %}
{% set build_number = 4 %}

package:
  name: {{ name }}
  version: {{ version }}

build:
  skip: True         # [python_impl == 'pypy' or win or py != 38]
  number: {{ build_number }}

outputs:
  - name: rubin-env-nosysroot
    script: build-nosysroot.sh
    # Since all requirements are required "at run time" for the
    # Rubin developers, all requirements are fundamentally
    # run requirements. However, we've attempted to organize
    # requirements as build-like, host-like, or run-like, in
    # order inform any evolution of this recipe.
    requirements:
      host:
        - python
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - boost
        - cfitsio
        - curl
        - fftw
        - gsl
        - libblas
        - libcblas
        - liblapack
        - liblapacke
        - log4cxx
        - mpich
      run:
        # jq is special - it is needed for the pin-it utility in this package
        - jq
        # build-like dependencies
        # As part of our scons build process, we do run tests, so
        # these really are required to perform a build.
        # Note that "testing" in conda-forge should be limited to testing
        # successful packaging, and not testing code.
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        # The above are needed to get the official conda-forge versions.
        # The below is needed to get convenience symlinks for users to invoke.
        - compilers
        - cmake
        # Coverage 6.3 is breaking with NFS and multi-process testing.
        - coverage >=3.6,!=6.3
        - coveralls
        - doxygen
        - flake8 =3.8.4
        - make
        - nose
        - pep8-naming
        - pip
        - psutil
        - pytest
        - pytest-cov
        - pytest-doctestplus
        - pytest-flake8
        - pytest-openfiles
        - pytest-runner
        - pytest-session2file
        - pytest-subtests
        - pytest-xdist
        - scons
        # host-like and run-like
        # These are mostly run-like, but for the same reasons as
        # above, we need most of these at build time, so they are mostly
        # host-like
        - boost {{ boost }}
        - cfitsio {{ cfitsio }}
        - eigen =3.3
        - eups
        - firefly-client
        - galsim
        - libaprutil =1
        # there is some issue with pex_exceptions with clang 11 and libcxx 12
        # until it is tracked down, it makes sense to keep these at the same
        # major version
        - libcxx =={{ cxx_compiler_version }}.*  # [osx]
        - llvmlite
        - log4cxx {{ log4cxx }}
        - lsst-documenteer-pipelines
        - lsst-documenteer-technote
        - minuit2 =6
        - mpich {{ mpich }}
        - numba
        - starlink-ast =9
        - wcslib =7
        - xpa =2
        # run-like
        - alembic
        - apr =1
        - astropy
        - astroquery
        - autograd
        - backoff
        - boto3
        - bottleneck
        # conda is required for runtime inspection of installed software
        - conda
        - configparser
        - cffi =1
        - click !=8.1.0,!=8.1.1
        - coloredlogs
        - cython =0
        - deprecated
        - dustmaps
        - emcee
        - esutil
        - fastavro
        - future
        - git
        - git-lfs
        - gsl {{ gsl }}
        - h5py
        - healpy
        - healsparse
        - idds-client >=0.9.5
        - idds-doma >=0.9.5
        # inflection may go away in the future; see DM-32591
        - inflection
        - iminuit >=2
        - lmfit !=1.0.3
        - lsstdesc.coord
        - matplotlib-base
        - moto >=3
        - mpi4py
        - ndarray =1
        - networkx
        - numexpr =2
        - numpy =1.20
        - pandas
        - pgcli
        - photutils >=0.7
        - piff
        - prmon  # [linux]
        - psycopg2 =2
        - pyarrow
        - pybind11
        - pydantic
        - pysynphot
        - pytables
        - python =3.8
        - pyyaml
        - requests
        - schwimmbad
        - scikit-image !=0.18
        - scikit-learn
        - scipy
        - seaborn
        - spherematch
        - sqlalchemy <2
        - sqlite
        - threadpoolctl
        - tqdm
        - treecorr =4
        - ws4py

    test:
      commands:
        # grep pin-it output for python dependency
        - pin-it rubin-env | grep "python="
        # ensure binary compatibility; bump major version if not
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1014 ]'  # [linux]
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1002 ]'  # [osx]

  - name: rubin-env
    requirements:
      run:
        - {{ pin_subpackage("rubin-env-nosysroot", exact=True) }}
        - sysroot_linux-64 =2.17  # [linux64]
    test:
      commands:
        # grep pin-it output for python dependency
        - pin-it rubin-env | grep "python="
        # ensure binary compatibility; bump major version if not
        - '[ $(echo __GXX_ABI_VERSION | ${GXX} -E - | tail -1) == 1014 ]'  # [linux]
        - '[ $(echo __GXX_ABI_VERSION | ${CXX} -E - | tail -1) == 1002 ]'  # [osx]

about:
  home: https://github.com/conda-forge/rubinenv-feedstock
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE.txt
  summary: Metapackage to install the Rubin Observatory's common software environment.

  description: |
    This metapackage exists to define the Rubin Observatory common software
    environment, including version specifications where needed, while allowing
    users flexibility when installing additional packages into the same environment.

extra:
  recipe-maintainers:
    - brianv0
    - timj
    - ktlim
    - beckermr
    - erykoff
